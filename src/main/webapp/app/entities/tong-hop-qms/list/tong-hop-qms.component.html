<div class="container-fluid py-3 main-content">
  <div class="header-sm">
    <h2 class="mb-3">Thống kê sản phẩm đổi trả theo LOT</h2>

    <div class="form-inline mb-3">
      <input
        type="text"
        class="form-control mr-2"
        placeholder="Scan hoặc nhập mã LOT"
        [(ngModel)]="scannedLot"
        (keydown.enter)="addLot()"
      />
      <button class="btn btn-primary" (click)="addLot()">Thêm LOT</button>
    </div>
  </div>

  <table class="table table-bordered table-hover">
    <thead class="thead-light">
      <tr>
        <th style="width: 3rem">STT</th>
        <th>Mã LOT</th>
        <th>Số lỗi BOM</th>
        <th>Số lần test NVL</th>
        <th>Số lần pass Scan100</th>
        <th>Tổng số lượng trả</th>
        <th style="width: 13rem">Chi tiết</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let lot of lotSummaries; let i = index">
        <td class="center-cell">{{ i + 1 }}</td>
        <td>{{ lot.lot }}</td>
        <td>{{ lot.bomErrors.length }} lỗi</td>
        <td>{{ lot.testNVL.length }} lần</td>
        <td>{{ lot.scan100Pass.length }} lần</td>
        <td>{{ lot.totalQty }}</td>
        <td class="options-column">
          <button class="btn btn-info btn-custom" (click)="openDetail(lot)">
            <fa-icon [icon]="faFileAlt"></fa-icon>
          </button>
          <button class="btn btn-secondary btn-custom" (click)="openItemSummary(lot.lot)">
            <fa-icon [icon]="faList"></fa-icon>
          </button>
        </td>
      </tr>
      <tr *ngIf="lotSummaries.length === 0">
        <td colspan="7" class="text-center text-muted">Chưa có dữ liệu. Vui lòng nhập LOT.</td>
      </tr>
    </tbody>
  </table>

  <!-- Modal Template -->

  <ng-template #detailModal let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Chi tiết LOT: {{ selectedLotDetail?.lot }}</h5>
      <button type="button" class="close" (click)="modal.dismiss()">&times;</button>
    </div>
    <div class="modal-body">
      <!-- A. BOM lỗi -->
      <div class="header-sm">
        <h4 class="mt-2">BOM lỗi</h4>
        <div class="buttons-action">
          <button type="button" class="btn btn-success" (click)="exportBomErrors()">
            <fa-icon [icon]="faFileExport"></fa-icon>
          </button>
        </div>
      </div>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 3rem">STT</th>
            <th>Mã lỗi</th>
            <th>Tên lỗi</th>
            <th>Số lượng</th>
            <th>Ghi chú</th>
            <th>Ngày tạo</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let e of selectedLotDetail?.bomErrors; let i = index">
            <td class="center-cell">{{ i + 1 }}</td>
            <td class="center-cell">{{ e.errorCode }}</td>
            <td class="center-cell">{{ e.errorName }}</td>
            <td class="center-cell">{{ e.quantity }}</td>
            <td>{{ e.note }}</td>
            <td class="center-cell">{{ e.createdAt }}</td>
          </tr>
          <tr *ngIf="selectedLotDetail?.bomErrors?.length === 0">
            <td colspan="5" class="text-center text-muted">Không có BOM lỗi</td>
          </tr>
        </tbody>
      </table>

      <!-- B. Kiểm tra NVL -->
      <div class="header-sm">
        <h4 class="mt-3">Kiểm tra NVL</h4>
        <div class="buttons-action">
          <button type="button" class="btn btn-success" (click)="exportCheckNVL()">
            <fa-icon [icon]="faFileExport"></fa-icon>
          </button>
        </div>
      </div>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 3rem">STT</th>
            <th>Người kiểm</th>
            <th>Kết luận</th>
            <th>Ghi chú</th>
            <th>Ngày kiểm</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of selectedLotDetail?.checkNVL; let i = index">
            <td class="center-cell">{{ i + 1 }}</td>
            <td>{{ c.CheckPerson }}</td>
            <td>{{ c.conclude }}</td>
            <td>{{ c.note }}</td>
            <td>{{ c.createdAt }}</td>
          </tr>
          <tr *ngIf="selectedLotDetail?.checkNVL?.length === 0">
            <td colspan="4" class="text-center text-muted">Không có dữ liệu kiểm NVL</td>
          </tr>
        </tbody>
      </table>

      <!-- C. Test NVL -->
      <div class="header-sm">
        <h4 class="mt-3">Test NVL</h4>
        <div class="buttons-action">
          <button type="button" class="btn btn-success" (click)="exportTestNVL()">
            <fa-icon [icon]="faFileExport"></fa-icon>
          </button>
        </div>
      </div>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 3rem">STT</th>
            <th style="width: 10rem">Tên vật tư</th>
            <th style="width: 6rem">Mã vật tư</th>
            <th style="width: 4rem">SL mẫu</th>
            <th style="width: 5rem">Kết quả</th>
            <th style="width: 6rem">Ngày kiểm</th>
            <th style="width: 8rem">Vendor</th>
            <th>Ghi chú</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let t of selectedLotDetail?.testNVL?.slice((testNVLPage - 1) * testNVLPageSize, testNVLPage * testNVLPageSize);
              let i = index
            "
          >
            <td class="center-cell">{{ (testNVLPage - 1) * testNVLPageSize + i + 1 }}</td>
            <td>{{ t.itemName }}</td>
            <td class="center-cell">{{ t.itemCode }}</td>
            <td class="center-cell">{{ t.sampleQuantity }}</td>
            <td class="center-cell">{{ t.realResult }}</td>
            <td class="center-cell">{{ t.checkDate }}</td>
            <td class="center-cell">{{ t.vendor }}</td>
            <td>{{ t.note }}</td>
          </tr>
          <tr *ngIf="selectedLotDetail?.testNVL?.length === 0">
            <td colspan="7" class="text-center text-muted">Không có dữ liệu Test NVL</td>
          </tr>
        </tbody>
      </table>
      <nav *ngIf="totalTestNVLPages > 1">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="testNVLPage === 1">
            <a class="page-link" (click)="testNVLPage = testNVLPage - 1">Trước</a>
          </li>

          <li
            class="page-item"
            *ngFor="let page of [].constructor(totalTestNVLPages); let i = index"
            [class.active]="testNVLPage === i + 1"
          >
            <a class="page-link" (click)="testNVLPage = i + 1">{{ i + 1 }}</a>
          </li>

          <li class="page-item" [class.disabled]="testNVLPage >= totalTestNVLPages">
            <a class="page-link" (click)="testNVLPage = testNVLPage + 1">Sau</a>
          </li>
        </ul>
      </nav>
      <!-- D. Scan100 Pass -->
      <div class="header-sm">
        <h4 class="mt-3">Scan100 Pass</h4>
        <div class="buttons-action">
          <button type="button" class="btn btn-success" (click)="exportScan100()">
            <fa-icon [icon]="faFileExport"></fa-icon>
          </button>
        </div>
      </div>
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 3rem">STT</th>
            <th>QR</th>
            <th>Vật tư</th>
            <th style="width: 10rem">Máy</th>
            <th>Người kiểm</th>
            <th>Ngày</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let s of selectedLotDetail?.scan100Pass?.slice((scan100Page - 1) * scan100PageSize, scan100Page * scan100PageSize);
              let i = index
            "
          >
            <td class="center-cell">{{ (scan100Page - 1) * scan100PageSize + i + 1 }}</td>
            <td>{{ s.qr }}</td>
            <td class="center-cell">{{ s.material }}</td>
            <td class="center-cell">{{ s.machine }}</td>
            <td class="center-cell">{{ s.user_check }}</td>
            <td class="center-cell">{{ s.date }}</td>
          </tr>
          <tr *ngIf="selectedLotDetail?.scan100Pass?.length === 0">
            <td colspan="5" class="text-center text-muted">Không có dữ liệu Scan100 Pass</td>
          </tr>
        </tbody>
      </table>
      <nav *ngIf="totalScan100Pages > 1">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="scan100Page === 1">
            <a class="page-link" (click)="scan100Page = scan100Page - 1">Trước</a>
          </li>

          <li
            class="page-item"
            *ngFor="let page of [].constructor(totalScan100Pages); let i = index"
            [class.active]="scan100Page === i + 1"
          >
            <a class="page-link" (click)="scan100Page = i + 1">{{ i + 1 }}</a>
          </li>

          <li class="page-item" [class.disabled]="scan100Page >= totalScan100Pages">
            <a class="page-link" (click)="scan100Page = scan100Page + 1">Sau</a>
          </li>
        </ul>
      </nav>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="modal.close()">Đóng</button>
    </div>
  </ng-template>
  <!-- Modal hiển thị danh sách sản phẩm trong LOT -->
  <ng-template #itemSummaryModal let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Sản phẩm trong LOT: {{ selectedLot }}</h5>
      <button type="button" class="close" (click)="modal.dismiss()">&times;</button>
    </div>
    <div class="modal-body">
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 3rem">STT</th>
            <th>Tên vật tư</th>
            <th>PartNumber</th>
            <th>Tổng số LOT</th>
            <th>Tổng SL trả</th>
            <th>Tổng lỗi BOM</th>
            <th>Tổng lỗi sửa</th>
            <th style="width: 6rem">Xem thêm</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of itemsInLot.slice((itemsPage - 1) * itemsPageSize, itemsPage * itemsPageSize); let i = index">
            <td class="center-cell">{{ (itemsPage - 1) * itemsPageSize + i + 1 }}</td>
            <td class="center-cell">{{ item.itemName }}</td>
            <td class="center-cell">{{ item.partNumber }}</td>
            <td class="center-cell">{{ item.totalLots }}</td>
            <td class="center-cell">{{ item.totalQty }}</td>
            <td class="center-cell">{{ item.totalBomErr }}</td>
            <td class="center-cell">{{ item.totalFixErr }}</td>
            <td class="center-cell">
              <button class="btn btn-info btn-custom" (click)="openLotList(item)">
                <fa-icon [icon]="faEye"></fa-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <nav *ngIf="totalItemsPages > 1">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="itemsPage === 1">
            <a class="page-link" (click)="itemsPage = itemsPage - 1">Trước</a>
          </li>
          <li class="page-item" *ngFor="let page of [].constructor(totalItemsPages); let i = index" [class.active]="itemsPage === i + 1">
            <a class="page-link" (click)="itemsPage = i + 1">{{ i + 1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="itemsPage >= totalItemsPages">
            <a class="page-link" (click)="itemsPage = itemsPage + 1">Sau</a>
          </li>
        </ul>
      </nav>
    </div>
  </ng-template>
  <!-- Modal hiển thị danh sách LOT theo vật tư -->
  <ng-template #lotListModal let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Các LOT của vật tư: {{ selectedItem?.itemName }}</h5>
      <button type="button" class="close" (click)="modal.dismiss()">&times;</button>
    </div>
    <div class="modal-body">
      <table class="table table-sm table-bordered">
        <thead>
          <tr>
            <th style="width: 3rem">STT</th>
            <th>LOT</th>
            <th>Tên vật tư</th>
            <th>PartNumber</th>
            <th>Tổng SL trả</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let lot of lotsOfItem.slice((lotsPage - 1) * lotsPageSize, lotsPage * lotsPageSize); let i = index">
            <td class="center-cell">{{ (lotsPage - 1) * lotsPageSize + i + 1 }}</td>
            <td class="center-cell">{{ lot.lot }}</td>
            <td class="center-cell">{{ lot.itemName }}</td>
            <td class="center-cell">{{ lot.partNumber }}</td>
            <td class="center-cell">{{ lot.totalQty }}</td>
          </tr>
        </tbody>
      </table>
      <nav *ngIf="totalLotsPages > 1">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="lotsPage === 1">
            <a class="page-link" (click)="lotsPage = lotsPage - 1">Trước</a>
          </li>
          <li class="page-item" *ngFor="let page of [].constructor(totalLotsPages); let i = index" [class.active]="lotsPage === i + 1">
            <a class="page-link" (click)="lotsPage = i + 1">{{ i + 1 }}</a>
          </li>
          <li class="page-item" [class.disabled]="lotsPage >= totalLotsPages">
            <a class="page-link" (click)="lotsPage = lotsPage + 1">Sau</a>
          </li>
        </ul>
      </nav>
    </div>
  </ng-template>
</div>
