<div class="container-fluid py-3 main-content">
  <div class="header-sm">
    <h2 class="mb-3">Thống kê vật tư theo LOT/Serial sản phẩm</h2>

    <div class="d-flex justify-content-between align-items-end flex-wrap mb-3">
      <form id="dateForm" class="formDate d-flex align-items-end gap-3 flex-wrap">
        <div class="search-inp">
          <label class="form-label-header">Ngày bắt đầu</label>
          <input
            class="form-control"
            type="date"
            id="startDate"
            [(ngModel)]="startDates"
            [ngModelOptions]="{ standalone: true }"
            (change)="changeDate()"
          />
        </div>
        <div class="search-inp">
          <label class="form-label-header">Ngày kết thúc</label>
          <input
            class="form-control"
            type="date"
            id="endDate"
            [(ngModel)]="endDates"
            [ngModelOptions]="{ standalone: true }"
            (change)="changeDate()"
          />
        </div>
        <button class="btn btn-success" (click)="changeDate()">Áp dụng</button>
      </form>
    </div>
  </div>

  <table class="table table-bordered table-hover sticky-table">
    <thead class="thead-light">
      <tr>
        <th style="min-width: 3rem">STT</th>
        <th style="min-width: 9rem">
          <span>Mã LOT</span>
          <input
            type="text"
            class="form-control form-control-sm"
            (keyup.enter)="filterData()"
            [(ngModel)]="searchTerms.lotNumber"
            placeholder="Tìm kiếm"
          />
        </th>
        <th style="min-width: 9rem">
          <span>Mã Tiếp Nhận</span>
          <input
            type="text"
            class="form-control form-control-sm"
            (keyup.enter)="filterData()"
            [(ngModel)]="searchTerms.maTiepNhan"
            placeholder="Tìm kiếm"
          />
        </th>
        <th style="min-width: 9rem">
          <span>Ngày Tiếp Nhận</span>
          <input
            type="text"
            class="form-control form-control-sm"
            (keyup.enter)="filterData()"
            [(ngModel)]="searchTerms.ngayTiepNhan"
            placeholder="Tìm kiếm"
          />
        </th>
        <th style="min-width: 9rem">
          <span>Nhân Viên Giao</span>
          <input
            type="text"
            class="form-control form-control-sm"
            (keyup.enter)="filterData()"
            [(ngModel)]="searchTerms.nhanVienGiaoHang"
            placeholder="Tìm kiếm"
          />
        </th>
        <th style="min-width: 10rem">
          <span>Nhóm Khách Hàng</span>
          <input
            type="text"
            class="form-control form-control-sm"
            (keyup.enter)="filterData()"
            [(ngModel)]="searchTerms.nhomKhachHang"
            placeholder="Tìm kiếm"
          />
        </th>
        <th style="min-width: 9rem">
          <span>Tên Khách Hàng</span>
          <input
            type="text"
            class="form-control form-control-sm"
            (keyup.enter)="filterData()"
            [(ngModel)]="searchTerms.tenKhachHang"
            placeholder="Tìm kiếm"
          />
        </th>
        <th style="min-width: 6rem"><span>Số Lượng Khách Giao</span></th>
        <th style="min-width: 6rem"><span>Số Lượng Thực Nhận</span></th>
        <th style="min-width: 6rem"><span>Tổng Số Lô Sản Xuất</span></th>
        <th style="max-width: 6rem">Chi tiết</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of pagedData; let i = index">
        <td>{{ (qmsPage - 1) * qmsPageSize + i + 1 }}</td>
        <td>{{ item.maLot }}</td>
        <td>{{ item.maTiepNhan }}</td>
        <td>{{ item.ngayTiepNhan | date: 'dd/MM/yyyy' }}</td>
        <td>{{ item.nhanVienGiao }}</td>
        <td>{{ item.nhomKhachHang || 'Chưa có' }}</td>
        <td>{{ item.tenKhachHang }}</td>
        <td>{{ item.soLuongKhachGiao }}</td>
        <td>{{ item.soLuongThucNhan }}</td>
        <td>{{ item.tongSoLoSanXuat }}</td>
        <td>
          <button class="btn btn-sm btn-primary" (click)="openLotDialog(item.maTiepNhan, lotModal)">
            <fa-icon [icon]="faEye"></fa-icon>
          </button>
        </td>
      </tr>
      <tr *ngIf="baoCaoVatTuList.length === 0">
        <td colspan="11" class="text-center text-muted">Đang load dữ liệu. Vui lòng đợi giây lát.</td>
      </tr>
    </tbody>
  </table>

  <ng-template #lotModal let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Danh sách số lô trong đơn: {{ selectedLot }}</h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
      <table class="table table-bordered table-sm">
        <thead class="table-light">
          <tr>
            <th>STT</th>
            <th>Mã LOT</th>
            <th>Tên Sản Phẩm</th>
            <th>Chi tiết</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of selectedLotItems; let i = index">
            <td>{{ i + 1 }}</td>
            <td>{{ item.lotNumber }}</td>
            <td>{{ item.tenSanPham }}</td>
            <td>
              <button class="btn btn-sm btn-info" (click)="openScanLotDialog(item.lotNumber)">
                <fa-icon [icon]="faList" style="color: #fff"></fa-icon>
              </button>
            </td>
          </tr>
          <tr *ngIf="selectedLotItems.length === 0">
            <td colspan="4" class="text-center text-muted">Không có dữ liệu cho lô này.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-template>

  <!-- Modal detail Template -->
  <ng-template #scanLotModal let-modal>
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Thông tin kiểm tra</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()">
          <!-- <span aria-hidden="true">&times;</span> -->
        </button>
      </div>

      <div class="modal-body thongtin-body">
        <!-- Loading -->
        <div class="text-center my-3" *ngIf="isLoading">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Đang tải dữ liệu...</p>
        </div>
        <div class="text-center text-danger my-3" *ngIf="lotMessage">
          {{ lotMessage }}
        </div>

        <!-- Bảng 1: BOM vật tư -->
        <div class="bom-table mt-4" *ngIf="listOfSanPhamTrongDialog.length > 0">
          <h5 class="mb-3">Thông tin BOM vật tư</h5>
          <div class="table-responsive">
            <table class="table table-hover table-bordered table-sm">
              <thead class="table-primary text-center align-middle">
                <tr>
                  <th>STT</th>
                  <th>Tên sản phẩm</th>
                  <th>LOT</th>
                  <th>Vendor</th>
                  <th>PartNumber</th>
                  <th>Mã sản phẩm</th>
                  <th>Năm sản xuất</th>
                  <th>Tổng lỗi</th>
                  <th>Tổng thực nhận</th>
                  <th>Ghi chú</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let item of listOfSanPhamTrongDialog; let i = index">
                  <tr *ngIf="item.type === 'bom'">
                    <td class="text-center">{{ i + 1 }}</td>
                    <td>{{ item.tenSanPham }}</td>
                    <td>{{ item.lotNumber }}</td>
                    <td>{{ item.vendor }}</td>
                    <td>{{ item.partNumber }}</td>
                    <td>{{ item.detail }}</td>
                    <td class="text-center">{{ item.namSanXuat }}</td>
                    <td class="text-end">{{ item.soLuongLoi | number }}</td>
                    <td class="text-end">{{ item.slThucNhap | number }}</td>
                    <td>{{ item.ghiChu }}</td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Bảng 2: Kiểm NVL -->
        <div class="testNVL-table" *ngIf="selectedLotDetail?.checkNVL?.length">
          <h5>Thông tin kiểm tra vật tư</h5>
          <table class="table table-bordered table-sm mt-3">
            <thead>
              <tr>
                <th style="width: 3rem">STT</th>
                <th>Người kiểm</th>
                <th>Kết luận</th>
                <th>Ghi chú</th>
                <th>Ngày kiểm</th>
                <th style="width: 5rem">Xem thêm</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let c of selectedLotDetail?.checkNVL; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ c.CheckPerson }}</td>
                <td>{{ c.conclude }}</td>
                <td>{{ c.note }}</td>
                <td>{{ c.createdAt | date: 'dd/MM/yyyy' }}</td>
                <td>
                  <button class="btn btn-sm btn-primary" (click)="openDetail(getLotSummaryByLotNumber(currentLotNumber))">
                    <fa-icon [icon]="faEye"></fa-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Bảng 3: Scan100 hoặc Check vật tư -->
        <div class="checkNVL-table" *ngIf="selectedLotDetail?.scan100Pass?.length">
          <h5>Thông tin Scan100</h5>
          <table class="table table-hover table-bordered table-sm mt-3">
            <thead class="table-primary text-center align-middle">
              <tr>
                <th>STT</th>
                <th>Tên sản phẩm</th>
                <th>LOT</th>
                <th>Vendor</th>
                <th>PartNumber</th>
                <th>Sap</th>
                <th>Username</th>
                <th>Nhân viên phân tích</th>
                <th>Ngày kiểm tra</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of selectedLotDetail?.scan100Pass; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ item.tenSanPham }}</td>
                <td>{{ item.lotNumber }}</td>
                <td>{{ item.vendor }}</td>
                <td>{{ item.partNumber }}</td>
                <td>{{ item.sap }}</td>
                <td>{{ item.username }}</td>
                <td>{{ item.tenNhanVienPhanTich }}</td>
                <td>{{ item.ngayKiemTra | date: 'dd/MM/yyyy' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="modal.dismiss()">Đóng</button>
      </div>
    </div>
  </ng-template>

  <ng-template #detailModal let-modal>
    <div class="modal-header">
      <h5 class="modal-title">Thông tin kiểm tra vật tư</h5>
      <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
    </div>
    <div class="modal-body">
      <table class="table table-hover table-bordered table-sm mt-3" *ngIf="selectedLotDetail?.testNVL?.length">
        <thead class="table-primary text-center align-middle">
          <tr>
            <th>STT</th>
            <th>Tên sản phẩm</th>
            <th>Part Number</th>
            <th>Số mẫu kiểm tra</th>
            <th>Ngày kiểm tra</th>
            <th>Quy định kiểm tra</th>
            <th>Số lỗi cho phép</th>
            <th>Số lỗi thực tế</th>
            <th>Thông số min</th>
            <th>Thông số max</th>
            <th>Đơn vị</th>
            <th>Ngày về</th>
            <th>Ghi chú</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of selectedLotDetail?.testNVL; let i = index">
            <td>{{ i + 1 }}</td>
            <td>{{ item.itemName }}</td>
            <td>{{ item.partNumber }}</td>
            <td>{{ item.sampleQuantity }}</td>
            <td>{{ item.checkDate | date: 'dd/MM/yyyy' }}</td>
            <td>{{ item.regulationCheck }}</td>
            <td>{{ item.allowResult }}</td>
            <td>{{ item.realResult }}</td>
            <td>{{ item.paramMin }}</td>
            <td>{{ item.paramMax }}</td>
            <td>{{ item.unit }}</td>
            <td>{{ item.returnDay | date: 'dd/MM/yyyy' }}</td>
            <td>{{ item.note }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="modal.close()">Đóng</button>
    </div>
  </ng-template>

  <nav class="paginate-main" *ngIf="baoCaoVatTuList.length > qmsPageSize">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="qmsPage === 1">
        <button class="page-link" (click)="changePage(qmsPage - 1)">Trước</button>
      </li>

      <li class="page-item" *ngFor="let page of totalPagesArray()" [class.active]="page === qmsPage">
        <button class="page-link" (click)="changePage(page)">{{ page }}</button>
      </li>

      <li class="page-item" [class.disabled]="qmsPage === totalPages()">
        <button class="page-link" (click)="changePage(qmsPage + 1)">Sau</button>
      </li>
    </ul>
  </nav>
</div>
